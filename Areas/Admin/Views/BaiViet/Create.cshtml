@model WEB_CV.Models.BaiViet
@{
    ViewData["Title"] = "Thêm bài viết";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<form asp-area="Admin"
      asp-controller="BaiViet"
      asp-action="Create"
      method="post"
      enctype="multipart/form-data">
  @Html.AntiForgeryToken()

  <partial name="_Form" model="Model" />

  <div class="toolbar-sticky">
    <div class="container-fluid d-flex justify-content-end gap-2">
      <a asp-area="Admin" asp-controller="BaiViet" asp-action="Index" class="btn btn-light">Hủy</a>
      <button type="submit" class="btn btn-primary btn-save">
        <i class="fas fa-save me-2"></i> Lưu
      </button>
    </div>
  </div>
</form>

@section Scripts{
  <partial name="_ValidationScriptsPartial" />
  <script>
    // autosize cho các textarea gắn class "autosize" (vd: TomTat)
    document.querySelectorAll('textarea.autosize').forEach(t=>{
      const resize=()=>{ t.style.height='auto'; t.style.height=t.scrollHeight+'px'; };
      t.addEventListener('input', resize); resize();
    });

    // Xử lý scheduled publishing
    document.addEventListener('DOMContentLoaded', function() {
      const scheduleDateTime = document.getElementById('scheduleDateTime');
      const schedulePublish = document.getElementById('schedulePublish');
      const ngayDangDuKien = document.querySelector('input[name="NgayDangDuKien"]');
      
      // Hiển thị/ẩn datetime picker
      document.querySelectorAll('input[name="PublishingType"]').forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'schedule') {
            scheduleDateTime.style.display = 'block';
            // Set minimum date to now
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            ngayDangDuKien.min = now.toISOString().slice(0, 16);
          } else {
            scheduleDateTime.style.display = 'none';
            ngayDangDuKien.value = '';
          }
        });
      });

      // Xử lý form submit
      document.querySelector('form').addEventListener('submit', function(e) {
        const selectedType = document.querySelector('input[name="PublishingType"]:checked').value;
        const ngayDangDuKienInput = document.querySelector('input[name="NgayDangDuKien"]');
        
        // Set hidden fields based on selection
        if (selectedType === 'now') {
          document.querySelector('input[name="TrangThai"]')?.remove();
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'TrangThai';
          input.value = '1';
          this.appendChild(input);
        } else if (selectedType === 'draft') {
          document.querySelector('input[name="TrangThai"]')?.remove();
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'TrangThai';
          input.value = '0';
          this.appendChild(input);
        } else if (selectedType === 'schedule') {
          if (!ngayDangDuKienInput.value) {
            e.preventDefault();
            alert('Vui lòng chọn thời gian đăng bài');
            return;
          }
          
          document.querySelector('input[name="TrangThai"]')?.remove();
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'TrangThai';
          input.value = '2';
          this.appendChild(input);
        }
      });
    });

    // trạng thái loading khi ấn Lưu
    document.querySelector('.btn-save')?.addEventListener('click', function(){
      this.classList.add('disabled');
      this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang lưu...';
    });
  </script>
}
