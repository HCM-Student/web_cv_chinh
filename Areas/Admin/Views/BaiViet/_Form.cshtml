@model WEB_CV.Models.BaiViet

<div class="page-form">
  <!-- Thông tin cơ bản -->
  <div class="form-section card shadow-sm mb-4">
    <div class="card-header bg-white d-flex align-items-center gap-2">
      <span class="section-chip"><i class="fas fa-info-circle"></i></span>
      <h5 class="mb-0">Thông tin cơ bản</h5>
    </div>
    <div class="card-body">
      <div asp-validation-summary="ModelOnly" class="alert alert-danger small mb-4"></div>

      <div class="row g-3">
        <div class="col-12">
          <label asp-for="TieuDe" class="form-label">Tiêu đề <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-heading"></i></span>
            <input asp-for="TieuDe" class="form-control" placeholder="Nhập tiêu đề bài viết" />
          </div>
          <span asp-validation-for="TieuDe" class="text-danger small"></span>
        </div>

        <div class="col-12">
          <label asp-for="TomTat" class="form-label">Tóm tắt</label>
          <textarea asp-for="TomTat" class="form-control autosize" rows="3" placeholder="Mô tả ngắn..."></textarea>
          <span asp-validation-for="TomTat" class="text-danger small"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Ảnh tiêu đề -->
  <div class="form-section card shadow-sm mb-4">
    <div class="card-header bg-white d-flex align-items-center gap-2">
      <span class="section-chip"><i class="fas fa-image"></i></span>
      <h5 class="mb-0">Ảnh tiêu đề</h5>
    </div>
    <div class="card-body">
      @if (!string.IsNullOrEmpty(Model?.AnhTieuDe))
      {
        <div class="mb-3">
          <img src="@Model.AnhTieuDe" alt="@Model.AnhTieuDeAlt" class="img-thumbnail" style="max-width:260px" />
        </div>
      }

      <div class="mb-3">
        <input type="file" name="AnhTieuDeFile" accept="image/*" class="form-control" />
        <div class="form-text">Chọn ảnh .jpg .png .webp .gif .svg</div>
      </div>

      @* Hiện checkbox xoá chỉ khi đang sửa và có ảnh *@
      @if (!string.IsNullOrEmpty(Model?.AnhTieuDe))
      {
        <div class="mb-3 form-check">
          <input class="form-check-input" type="checkbox" name="removeThumb" id="removeThumb" />
          <label class="form-check-label" for="removeThumb">Xoá ảnh hiện tại</label>
        </div>
      }

      <div class="mb-3">
        <label asp-for="AnhTieuDeAlt" class="form-label">Mô tả ảnh (alt)</label>
        <input asp-for="AnhTieuDeAlt" class="form-control" placeholder="Mô tả ngắn nội dung ảnh (SEO & trợ năng)" />
        <span asp-validation-for="AnhTieuDeAlt" class="text-danger"></span>
      </div>
    </div>
  </div>

  <!-- Gemini AI Assistant -->
  <partial name="_GeminiAssistant" />

  <!-- Nội dung -->
  <div class="form-section card shadow-sm mb-4">
    <div class="card-header bg-white d-flex align-items-center gap-2">
      <span class="section-chip"><i class="fas fa-align-left"></i></span>
      <h5 class="mb-0">Nội dung</h5>
    </div>
    <div class="card-body">
      <label asp-for="NoiDung" class="form-label">Nội dung</label>
      <!-- lưu ý: không dùng autosize cho textarea được thay thế bởi TinyMCE -->
      <textarea asp-for="NoiDung" class="form-control" rows="12" placeholder="Soạn thảo nội dung..."></textarea>

      <!-- TinyMCE: soạn thảo + upload ảnh -->
      <script src="https://cdn.tiny.cloud/1/5y7eprut3aap74ydqqc1ffaqszfn9qi6lc1lzned67e6k039/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          tinymce.init({
            selector: 'textarea[name="NoiDung"]',
            branding: false, promotion: false,
            height: 520, menubar: false,
            plugins: 'image link lists table code autoresize',
            toolbar: 'undo redo | blocks | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | image link table | code',
            content_style: 'body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:16px;line-height:1.6;} img{max-width:100%;height:auto;}',

            /* Upload tự động khi dán/kéo thả */
            automatic_uploads: true,
            convert_urls: false,
            images_upload_url: '@Url.Action("Upload","Media", new { area="Admin", folder = "posts" })',
            images_reuse_filename: false,
            paste_data_images: true,

            /* Nút chọn file ảnh mở file picker và upload luôn */
            file_picker_types: 'image',
            file_picker_callback: (cb, value, meta) => {
              if (meta.filetype !== 'image') return;
              const input = document.createElement('input');
              input.type = 'file'; input.accept = 'image/*';
              input.onchange = function () {
                const file = this.files[0];
                const form = new FormData();
                form.append('file', file, file.name);
                fetch('@Url.Action("Upload","Media", new { area="Admin", folder = "posts" })', {
                  method: 'POST',
                  body: form,
                  credentials: 'same-origin'
                })
                .then(r => r.json())
                .then(json => cb(json.location))
                .catch(err => alert('Upload lỗi: ' + err));
              };
              input.click();
            }
          });
        });
      </script>

      <span asp-validation-for="NoiDung" class="text-danger small"></span>
      <div class="form-text mt-2">Bạn có thể dán HTML/đoạn văn bản đã định dạng.</div>
    </div>
  </div>

  <!-- Phân loại -->
  <div class="form-section card shadow-sm mb-4">
    <div class="card-header bg-white d-flex align-items-center gap-2">
      <span class="section-chip"><i class="fas fa-sitemap"></i></span>
      <h5 class="mb-0">Phân loại</h5>
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-lg-6">
          <label asp-for="ChuyenMucId" class="form-label">Chuyên mục <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-folder-tree"></i></span>
            <select asp-for="ChuyenMucId" class="form-select" asp-items="ViewBag.ChuyenMucId">
              <option value="">-- chọn chuyên mục --</option>
            </select>
          </div>
          <span asp-validation-for="ChuyenMucId" class="text-danger small"></span>
        </div>

        <div class="col-auto">
          <a asp-area="Admin" asp-controller="ChuyenMuc" asp-action="Create" target="_blank" class="btn btn-outline-secondary">
            <i class="fas fa-plus"></i> Thêm
          </a>
        </div>

        <div class="col-lg-6">
          <label asp-for="TacGiaId" class="form-label">Tác giả <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-user-pen"></i></span>
            <select asp-for="TacGiaId" class="form-select" asp-items="ViewBag.TacGiaId">
              <option value="">-- chọn tác giả --</option>
            </select>
          </div>
          <span asp-validation-for="TacGiaId" class="text-danger small"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Scheduled Publishing -->
  <div class="form-section card shadow-sm mb-4">
    <div class="card-header bg-white d-flex align-items-center gap-2">
      <span class="section-chip"><i class="fas fa-clock"></i></span>
      <h5 class="mb-0">Lên lịch đăng bài</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="PublishingType" id="publishNow" value="now" checked>
            <label class="form-check-label" for="publishNow">
              <strong>Đăng ngay</strong>
              <small class="text-muted d-block">Bài viết sẽ được đăng ngay lập tức</small>
            </label>
          </div>
        </div>

        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="PublishingType" id="saveDraft" value="draft">
            <label class="form-check-label" for="saveDraft">
              <strong>Lưu bản nháp</strong>
              <small class="text-muted d-block">Lưu bài viết để chỉnh sửa sau</small>
            </label>
          </div>
        </div>

        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="PublishingType" id="schedulePublish" value="schedule">
            <label class="form-check-label" for="schedulePublish">
              <strong>Lên lịch đăng</strong>
              <small class="text-muted d-block">Chọn thời gian đăng bài trong tương lai</small>
            </label>
          </div>
        </div>

        <div class="col-12" id="scheduleDateTime" style="display: none;">
          <label asp-for="NgayDangDuKien" class="form-label">Thời gian đăng bài</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
            <input asp-for="NgayDangDuKien" type="datetime-local" class="form-control" />
          </div>
          <span asp-validation-for="NgayDangDuKien" class="text-danger small"></span>
          <div class="form-text">Chọn ngày và giờ để đăng bài viết</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Widget SEO -->
  <partial name="_SEOWidget" model="Model" />
</div>

<style>
  /* Tránh lớp khác đè lên editor (nếu có) */
  .tox-tinymce{ position: relative; z-index: 1; }
</style>
