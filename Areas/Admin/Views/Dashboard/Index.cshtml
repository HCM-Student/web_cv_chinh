@using WEB_CV.Data
@using System.Text.Json
@using Microsoft.EntityFrameworkCore
@inject NewsDbContext Context
@model WEB_CV.Areas.Admin.Controllers.DashboardController.MediaDashboardVm

@{
    ViewData["Title"] = "Dashboard";

    var totalBaiViet = Context.BaiViets.Count();
    var totalChuyenMuc = Context.ChuyenMucs.Count();
    var totalNguoiDung = Context.NguoiDungs.Count();
    var baiVietMoi = Context.BaiViets.Where(b => b.NgayDang >= DateTime.Today.AddDays(-7)).Count();
    var totalLienHe = Context.LienHes.Count();
    var lienHeChuaXuLy = Context.LienHes.Where(l => !l.DaXuLy).Count();
    var baiVietXemNhieu = Context.BaiViets.Include(b => b.TacGia).OrderByDescending(b => b.LuotXem).Take(5).ToList();
    var baiVietMoiNhat = Context.BaiViets.Include(b => b.TacGia).OrderByDescending(b => b.NgayDang).Take(5).ToList();

    // ====== Dá»® LIá»†U BIá»‚U Äá»’ VÃ’NG TRÃ’N (phÃ¢n bá»‘ vai trÃ² ngÆ°á»i dÃ¹ng) ======
    var roleCounts = Context.NguoiDungs
        .GroupBy(u => string.IsNullOrWhiteSpace(u.VaiTro) ? "KhÃ¡c" : u.VaiTro)
        .Select(g => new { Role = g.Key, Count = g.Count() })
        .OrderByDescending(x => x.Count)
        .ToList();
    var roleLabels = roleCounts.Select(x => x.Role).ToArray();
    var roleData   = roleCounts.Select(x => x.Count).ToArray();

    // (tuá»³ chá»n) line chart 7 ngÃ y gáº§n nháº¥t cho bÃ i viáº¿t
    var start = DateTime.Today.AddDays(-6);
    var days = Enumerable.Range(0, 7).Select(i => start.AddDays(i)).ToList();
    var dayLabels = days.Select(d => d.ToString("dd/MM")).ToArray();
    var postPerDay = days.Select(d => Context.BaiViets.Count(b => b.NgayDang.Date == d.Date)).ToArray();
}

<div class="admin-dashboard-page">
    <!-- Header Section -->
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-tachometer-alt text-primary me-2"></i>
                    Dashboard Overview
                </h1>
                <p class="page-subtitle text-muted">Chào mừng trở lại! Đây là tổng quan hệ thống của bạn</p>
            </div>
            <div class="btn-group">
                <button class="btn btn-outline-primary btn-lg">
                    <i class="fas fa-download me-2"></i>Export
                </button>
                <a class="btn btn-primary btn-lg" asp-area="Admin" asp-controller="BaiViet" asp-action="Create">
                    <i class="fas fa-plus me-2"></i>Tạo bài viết
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="stats-card modern-card">
                <div class="stats-card-content">
                    <div class="stats-info">
                        <span class="stats-label">Tổng bài viết</span>
                        <h2 class="stats-value">@totalBaiViet</h2>
                        <div class="stats-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>+@baiVietMoi tuần này</span>
                        </div>
                    </div>
                    <div class="stats-icon bg-primary">
                        <i class="fas fa-newspaper"></i>
                    </div>
                </div>
                <div class="stats-footer">
                    <a asp-area="Admin" asp-controller="BaiViet" asp-action="Index" class="stats-link">
                        Xem chi tiết <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="stats-card modern-card">
                <div class="stats-card-content">
                    <div class="stats-info">
                        <span class="stats-label">Liên hệ chưa xử lý</span>
                        <h2 class="stats-value">@lienHeChuaXuLy</h2>
                        <div class="stats-change @(lienHeChuaXuLy > 0 ? "negative" : "positive")">
                            <i class="fas fa-@(lienHeChuaXuLy > 0 ? "exclamation-triangle" : "check-circle")"></i>
                            <span>@(lienHeChuaXuLy > 0 ? "Cần xử lý" : "Đã xử lý hết")</span>
                        </div>
                    </div>
                    <div class="stats-icon bg-warning">
                        <i class="fas fa-envelope"></i>
                    </div>
                </div>
                <div class="stats-footer">
                    <a asp-area="Admin" asp-controller="LienHe" asp-action="Index" class="stats-link">
                        Xem liên hệ <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="stats-card modern-card">
                <div class="stats-card-content">
                    <div class="stats-info">
                        <span class="stats-label">Chuyên mục</span>
                        <h2 class="stats-value">@totalChuyenMuc</h2>
                        <div class="stats-change positive">
                            <i class="fas fa-check-circle"></i>
                            <span>Hoạt động tốt</span>
                        </div>
                    </div>
                    <div class="stats-icon bg-success">
                        <i class="fas fa-folder-open"></i>
                    </div>
                </div>
                <div class="stats-footer">
                    <a asp-area="Admin" asp-controller="ChuyenMuc" asp-action="Index" class="stats-link">
                        Quản lý <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="stats-card modern-card">
                <div class="stats-card-content">
                    <div class="stats-info">
                        <span class="stats-label">Tổng lượt xem</span>
                        <h2 class="stats-value">@Context.BaiViets.Sum(b => b.LuotXem)</h2>
                        <div class="stats-change positive">
                            <i class="fas fa-chart-line"></i>
                            <span>@baiVietXemNhieu.FirstOrDefault()?.LuotXem lượt xem cao nhất</span>
                        </div>
                    </div>
                    <div class="stats-icon bg-info">
                        <i class="fas fa-eye"></i>
                    </div>
                </div>
                <div class="stats-footer">
                    <a asp-area="Admin" asp-controller="BaiViet" asp-action="Index" class="stats-link">
                        Analytics <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="quick-actions-section">
                <h5 class="section-title mb-3">
                    <i class="fas fa-magic me-2"></i> Thao tác nhanh
                </h5>
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <a class="quick-action-card" asp-area="Admin" asp-controller="BaiViet" asp-action="Create">
                            <div class="quick-action-icon primary-bg"><i class="fas fa-pen"></i></div>
                            <div class="quick-action-text">
                                <span class="action-title">Viết bài mới</span>
                                <span class="action-desc">Tạo nội dung</span>
                            </div>
                            <i class="fas fa-chevron-right arrow-icon"></i>
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <a class="quick-action-card" asp-area="Admin" asp-controller="ChuyenMuc" asp-action="Create">
                            <div class="quick-action-icon success-bg"><i class="fas fa-folder-plus"></i></div>
                            <div class="quick-action-text">
                                <span class="action-title">Thêm chuyên mục</span>
                                <span class="action-desc">Tạo danh mục</span>
                            </div>
                            <i class="fas fa-chevron-right arrow-icon"></i>
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <a class="quick-action-card" asp-area="Admin" asp-controller="NguoiDung" asp-action="Create">
                            <div class="quick-action-icon secondary-bg"><i class="fas fa-user-plus"></i></div>
                            <div class="quick-action-text">
                                <span class="action-title">Thêm người dùng</span>
                                <span class="action-desc">Quản lý user</span>
                            </div>
                            <i class="fas fa-chevron-right arrow-icon"></i>
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <a class="quick-action-card" asp-area="Admin" asp-controller="BaoCao" asp-action="Index">
                            <div class="quick-action-icon primary-light-bg"><i class="fas fa-chart-bar"></i></div>
                            <div class="quick-action-text">
                                <span class="action-title">Xem báo cáo</span>
                                <span class="action-desc">Thống kê</span>
                            </div>
                            <i class="fas fa-chevron-right arrow-icon"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <!-- Xu hÆ°á»›ng 7 ngÃ y (line) -->
        <div class="col-lg-6">
            <div class="content-card h-100">
                <div class="content-card-header">
                    <h5 class="card-title"><i class="fas fa-chart-line me-2"></i>Xu hướng bài viết (7 ngày)</h5>
                </div>
                <div class="content-card-body">
                    <canvas id="postTrend" height="130"></canvas>
                </div>
            </div>
        </div>

        <!-- VÃ²ng trÃ²n khÃ¡ch quan -->
        <div class="col-lg-6">
            <div class="content-card h-100">
                <div class="content-card-header">
                    <h5 class="card-title"><i class="fas fa-chart-pie me-2"></i>Phân bổ vai trò người dùng</h5>
                </div>
                <div class="content-card-body d-flex justify-content-center align-items-center">
                    <canvas id="userRoleChart" style="max-height:260px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Grid -->
    <div class="row g-4">
        <!-- Bài viết được xem nhiều nhất -->
        <div class="col-lg-6">
    <div class="content-card">
                <div class="content-card-header">
                    <h5 class="card-title"><i class="fas fa-fire me-2"></i>Bài viết được xem nhiều nhất</h5>
                    <a asp-area="Admin" asp-controller="BaiViet" asp-action="Index" class="btn btn-sm btn-outline-primary">Xem tất cả</a>
      </div>
      <div class="content-card-body">
                    <div class="popular-posts-list">
                        @if (baiVietXemNhieu.Any())
                        {
                            int popularIndex = 1;
                            @foreach (var post in baiVietXemNhieu)
                            {
                                <div class="popular-post-item">
                                    <div class="post-thumbnail">
                                        @if (!string.IsNullOrEmpty(post.AnhTieuDe))
                                        {
                                            <img src="@post.AnhTieuDe" alt="@post.TieuDe" class="thumbnail-img">
                                        }
                                        else
                                        {
                                            <div class="thumbnail-placeholder">
                                                <i class="fas fa-image"></i>
                                            </div>
                                        }
                                    </div>
                                    <div class="post-content">
                                        <h6 class="post-title">@post.TieuDe</h6>
                                        <div class="post-meta">
                                            <span class="post-views">
                                                <i class="fas fa-eye me-1"></i>@post.LuotXem lượt xem
          </span>
                                            <span class="post-date">
                                                <i class="fas fa-calendar me-1"></i>@post.NgayDang.ToString("dd/MM/yyyy")
          </span>
        </div>
                                    </div>
                                    <div class="post-rank">
                                        <span class="rank-number">@popularIndex</span>
                                    </div>
              </div>
              popularIndex++;
            }
          }
          else
          {
                            <div class="text-muted text-center py-4">Chưa có dữ liệu</div>
          }
      </div>
    </div>
  </div>
</div>

        <!-- Bài viết mới nhất -->
        <div class="col-lg-6">
            <div class="content-card">
                <div class="content-card-header">
                    <h5 class="card-title"><i class="fas fa-clock me-2"></i>Bài viết mới nhất</h5>
                    <a asp-area="Admin" asp-controller="BaiViet" asp-action="Index" class="btn btn-sm btn-outline-primary">Xem tất cả</a>
                </div>
                <div class="content-card-body">
                    <div class="recent-posts-list">
                        @if (baiVietMoiNhat.Any())
                        {
                            @foreach (var post in baiVietMoiNhat)
                            {
                                <div class="recent-post-item">
                                    <div class="post-thumbnail">
                                        @if (!string.IsNullOrEmpty(post.AnhTieuDe))
                                        {
                                            <img src="@post.AnhTieuDe" alt="@post.TieuDe" class="thumbnail-img">
                                        }
                                        else
                                        {
                                            <div class="thumbnail-placeholder">
                                                <i class="fas fa-image"></i>
                                            </div>
                                        }
                                    </div>
                                    <div class="post-content">
                                        <h6 class="post-title">@post.TieuDe</h6>
                                        <div class="post-meta">
                                            <span class="post-author">
                                                <i class="fas fa-user me-1"></i>@(post.TacGia?.HoTen ?? "Chưa có")
                                            </span>
                                            <span class="post-date">
                                                <i class="fas fa-calendar me-1"></i>@post.NgayDang.ToString("dd/MM/yyyy")
                                            </span>
                                        </div>
                                        @if (!string.IsNullOrWhiteSpace(post.TomTat))
                                        {
                                            <p class="post-excerpt">@(post.TomTat.Length > 80 ? post.TomTat.Substring(0, 80) + "..." : post.TomTat)</p>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-muted text-center py-4">Chưa có dữ liệu</div>
                        }
                    </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Recent Activity -->
    <div class="row g-4 mt-4">
        <div class="col-12">
            <div class="content-card">
                <div class="content-card-header">
                    <h5 class="card-title"><i class="fas fa-history me-2"></i>Hoạt động gần đây</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="loadActivities()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-filter"></i></button>
                    </div>
                </div>
                <div class="content-card-body">
                    <div id="recentActivities" class="activity-list">
                        <div class="text-muted small">Đang tải hoạt động gần đây...</div>
                        <div class="text-info small mt-2">Nếu không tải được, hãy click nút refresh ở trên</div>
                        <div class="text-warning small mt-2" id="testMessage">Chờ JavaScript chạy...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Dashboard Styles */
.admin-dashboard-page {
    padding: 2rem;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
    position: relative;
}

.admin-dashboard-page::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="rgba(0,0,0,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    opacity: 0.3;
    pointer-events: none;
}

.page-header {
    margin-bottom: 2rem;
    position: relative;
    z-index: 2;
}

.page-title {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 0;
    color: #1a202c;
    display: flex;
    align-items: center;
}

.page-subtitle {
    font-size: 1.1rem;
    margin: 0.5rem 0 0 0;
    color: #6c757d;
    font-weight: 400;
}

/* Stats Cards */
.stats-card {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 2rem;
    box-shadow: 0 8px 32px rgba(0,0,0,0.08);
    border: 1px solid rgba(255,255,255,0.3);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    height: 180px;
    display: flex;
    flex-direction: column;
}

.modern-card {
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 
        0 8px 32px rgba(0,0,0,0.1),
        inset 0 1px 0 rgba(255,255,255,0.5);
}

.modern-card:hover {
    transform: translateY(-12px) scale(1.02);
    box-shadow: 
        0 20px 60px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.6);
    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.8));
}

.stats-card-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    height: 100%;
}

.stats-info {
    flex: 1;
}

.stats-label {
    font-size: 0.9rem;
    color: #4a5568;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stats-value {
    font-size: 2.8rem;
    font-weight: 800;
    margin: 0.5rem 0;
    background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-change {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    font-weight: 600;
}

.stats-change.positive {
    color: #059669;
}

.stats-change.negative {
    color: #dc2626;
}

.stats-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    flex-shrink: 0;
}

.modern-card .stats-icon {
    background: linear-gradient(135deg, #1e3a8a, #3b82f6);
    box-shadow: 0 4px 15px rgba(30, 58, 138, 0.2);
}

.modern-card .stats-icon::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.2), transparent);
    border-radius: 12px;
}

.modern-card:hover .stats-icon {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(30, 58, 138, 0.3);
}

.stats-footer {
    border-top: 1px solid rgba(0,0,0,0.05);
    padding-top: 1rem;
}

.stats-link {
    color: #4f46e5;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    background: rgba(79, 70, 229, 0.1);
}

.stats-link:hover {
    color: #3730a3;
    text-decoration: none;
    background: rgba(79, 70, 229, 0.15);
    transform: translateX(5px);
}

/* Content Cards */
.content-card {
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
    backdrop-filter: blur(20px);
    border-radius: 24px;
    box-shadow: 
        0 8px 32px rgba(0,0,0,0.1),
        inset 0 1px 0 rgba(255,255,255,0.5);
    border: 1px solid rgba(255,255,255,0.3);
    position: relative;
    z-index: 2;
    transition: all 0.3s ease;
}

.content-card:hover {
    transform: translateY(-5px);
    box-shadow: 
        0 15px 45px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.6);
}

.content-card-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #1a202c;
    margin: 0;
}

.content-card-body {
    padding: 2rem;
}

/* Popular Posts */
.popular-posts-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.popular-post-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 12px;
    transition: all 0.3s ease;
    position: relative;
}

.popular-post-item:hover {
    background: #e9ecef;
    transform: translateX(5px);
}

.post-thumbnail {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.thumbnail-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.thumbnail-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #adb5bd;
    font-size: 1.5rem;
}

.post-content {
    flex: 1;
    min-width: 0;
}

.post-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1a202c;
    margin: 0 0 0.5rem 0;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.post-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.8rem;
    color: #4a5568;
}

.post-views, .post-date, .post-author {
    display: flex;
    align-items: center;
}

.post-rank {
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.9rem;
    flex-shrink: 0;
}

/* Recent Posts */
.recent-posts-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.recent-post-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.recent-post-item:hover {
    background: #e9ecef;
    transform: translateX(5px);
}

.post-excerpt {
    font-size: 0.85rem;
    color: #4a5568;
    line-height: 1.4;
    margin: 0.5rem 0 0 0;
}

/* Quick Actions */
.quick-actions-section {
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 2rem;
    box-shadow: 
        0 8px 32px rgba(0,0,0,0.1),
        inset 0 1px 0 rgba(255,255,255,0.5);
    border: 1px solid rgba(255,255,255,0.3);
    position: relative;
    z-index: 2;
    transition: all 0.3s ease;
}

.quick-actions-section:hover {
    transform: translateY(-3px);
    box-shadow: 
        0 12px 40px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.6);
}

.section-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #1a202c;
    margin: 0;
}

.quick-action-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    background: white;
    border-radius: 15px;
    text-decoration: none;
    color: inherit;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid rgba(0,0,0,0.05);
}

.quick-action-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    color: inherit;
    text-decoration: none;
}

.quick-action-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.primary-bg { background: linear-gradient(135deg, #667eea, #764ba2); }
.success-bg { background: linear-gradient(135deg, #4facfe, #00f2fe); }
.secondary-bg { background: linear-gradient(135deg, #43e97b, #38f9d7); }
.primary-light-bg { background: linear-gradient(135deg, #f093fb, #f5576c); }

.quick-action-text {
    flex: 1;
}

.action-title {
    display: block;
    font-weight: 600;
    color: #1a202c;
    margin-bottom: 0.25rem;
}

.action-desc {
    display: block;
    font-size: 0.85rem;
    color: #4a5568;
}

.arrow-icon {
    color: #adb5bd;
    transition: all 0.3s ease;
}

.quick-action-card:hover .arrow-icon {
    color: #4f46e5;
    transform: translateX(3px);
}

/* Activity List */
.activity-list {
    max-height: 400px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}

.activity-item:hover {
    background: #f8f9fa;
}

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.activity-content {
    flex: 1;
}

.activity-text {
    margin: 0 0 0.25rem 0;
    color: #1a202c;
    font-weight: 500;
}

.activity-time {
    font-size: 0.8rem;
    color: #4a5568;
}

/* Responsive */
@@media (max-width: 768px) {
    .dashboard-container {
        padding: 1rem;
    }
    
    .page-header-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .page-title {
        font-size: 2rem;
    }
    
    .stats-card {
        padding: 1.5rem;
    }
    
    .stats-value {
        font-size: 2rem;
    }
    
    .content-card-body {
        padding: 1.5rem;
    }
    
    .popular-post-item,
    .recent-post-item {
        flex-direction: column;
        align-items: flex-start;
        text-align: left;
    }
    
    .post-thumbnail {
        width: 100%;
        height: 120px;
    }
}
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Update current time
function updateTime() {
    const now = new Date();
    const options = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
    const timeString = now.toLocaleDateString('vi-VN', options);
    const timeElement = document.getElementById('current-time');
    if (timeElement) timeElement.textContent = timeString;
}
setInterval(updateTime, 60000); updateTime();

// ===== Doughnut: phÃ¢n bá»‘ vai trÃ² ngÆ°á»i dÃ¹ng =====
const roleLabels = @Html.Raw(JsonSerializer.Serialize(roleLabels));
const roleData   = @Html.Raw(JsonSerializer.Serialize(roleData));
const palette = ["#3b82f6","#ef4444","#10b981","#f59e0b","#8b5cf6","#06b6d4","#f97316","#84cc16","#e11d48","#0891b2"];
const roleBg = roleLabels.map((_, i) => palette[i % palette.length]);

new Chart(document.getElementById('userRoleChart'), {
    type: 'doughnut',
    data: { labels: roleLabels, datasets: [{ data: roleData, backgroundColor: roleBg, borderWidth: 0 }] },
    options: {
        responsive: true, cutout: '60%',
        plugins: {
            legend: { position: 'bottom' },
            tooltip: {
                callbacks: {
                    label: (ctx) => {
                        const total = roleData.reduce((a,b)=>a+b,0) || 1;
                        const val = ctx.parsed; const pct = Math.round((val/total)*100);
                        return `${ctx.label}: ${val} (${pct}%)`;
                    }
                }
            }
        }
    }
});

// ===== Line: xu hÆ°á»›ng bÃ i viáº¿t 7 ngÃ y =====
const dayLabels = @Html.Raw(JsonSerializer.Serialize(dayLabels));
const postPerDay = @Html.Raw(JsonSerializer.Serialize(postPerDay));

new Chart(document.getElementById('postTrend'), {
    type: 'line',
    data: {
        labels: dayLabels,
        datasets: [{
            data: postPerDay,
            tension: .35,
            fill: true,
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
        plugins: { legend: { display: false } }
    }
});

// Fix mojibake text if file encoding is wrong
document.addEventListener('DOMContentLoaded', function(){
    const createBtn = document.querySelector('.page-actions a.btn.btn-primary');
    if (createBtn) {
        createBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Tạo bài viết';
    }
});
</script>
<script>
function timeAgo(iso){
  const t = new Date(iso);
  const s = Math.floor((Date.now() - t.getTime())/1000);
  const m = Math.floor(s/60), h=Math.floor(m/60), d=Math.floor(h/24);
  if (s < 60) return s + 's trước';
  if (m < 60) return m + ' phút trước';
  if (h < 24) return h + ' giờ trước';
  return d + ' ngày trước';
}
function iconFor(type){
  if(type==='user') return { cls:'bg-success', icon:'fa-user-plus' };
  if(type==='post') return { cls:'bg-primary', icon:'fa-file-alt' };
  return { cls:'bg-secondary', icon:'fa-bell' };
}
async function loadActivities(){
  try{
    console.log('Loading activities...');
    const res = await fetch('/Admin/Dashboard/RecentActivities?take=8', { cache:'no-store' });
    console.log('Response status:', res.status);
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    console.log('Data received:', data);
    
    const list = document.getElementById('recentActivities');
    if(list){
      if(!Array.isArray(data.activities) || data.activities.length===0){ 
        list.innerHTML = '<div class="text-muted small">Không có hoạt động.</div>'; 
      }
      else {
        list.innerHTML = data.activities.map(a=>{
          const ic = iconFor(a.type);
          return `
            <div class="activity-item">
              <div class="activity-icon ${ic.cls}"><i class="fas ${ic.icon}"></i></div>
              <div class="activity-content">
                <p class="activity-text">${a.message}</p>
                <span class="activity-time">${new Date(a.createdAt).toLocaleString('vi-VN')}</span>
              </div>
            </div>`;
        }).join('');
      }
    }
    
    const bell = document.getElementById('notifBellCount');
    const mail = document.getElementById('notifMailCount');
    if (bell) bell.textContent = (data.bellCount ?? data.activities.length).toString();
    if (mail) mail.textContent = (data.mailCount ?? 0).toString();
    
    console.log('Activities loaded successfully');
  }catch(e){ 
    console.error('Error loading activities:', e);
    const list = document.getElementById('recentActivities');
    if(list) {
      list.innerHTML = '<div class="text-danger small">Lỗi tải dữ liệu: ' + e.message + '</div>';
    }
  }
}
// Test ngay khi load trang
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, starting activities...');
    
    // Test đơn giản trước
    const testDiv = document.getElementById('recentActivities');
    if (testDiv) {
        testDiv.innerHTML = '<div class="text-success small">JavaScript đang chạy! Đang tải dữ liệu...</div>';
    }
    
    // Test API trực tiếp
    fetch('/Admin/Dashboard/RecentActivities?take=5')
        .then(response => {
            console.log('API Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API Data:', data);
            // Hiển thị dữ liệu ngay lập tức
            if (testDiv) {
                testDiv.innerHTML = '<div class="text-success small">API hoạt động! Có ' + (data.activities ? data.activities.length : 0) + ' hoạt động</div>';
            }
        })
        .catch(error => {
            console.error('API Error:', error);
            if (testDiv) {
                testDiv.innerHTML = '<div class="text-danger small">Lỗi API: ' + error.message + '</div>';
            }
        });
    
    loadActivities();
    setInterval(loadActivities, 30000);
});

// Test ngay khi load trang - cách khác
window.onload = function() {
    console.log('Window loaded, testing activities...');
    
    const testDiv = document.getElementById('recentActivities');
    if (testDiv) {
        testDiv.innerHTML = '<div class="text-warning small">Window loaded! Testing API...</div>';
    }
    
    // Test API
    fetch('/Admin/Dashboard/RecentActivities?take=3')
        .then(response => response.json())
        .then(data => {
            console.log('API Data:', data);
            if (testDiv) {
                testDiv.innerHTML = '<div class="text-success small">API OK! Có ' + (data.activities ? data.activities.length : 0) + ' hoạt động</div>';
            }
        })
        .catch(error => {
            console.error('API Error:', error);
            if (testDiv) {
                testDiv.innerHTML = '<div class="text-danger small">Lỗi: ' + error.message + '</div>';
            }
        });
};

// Test đơn giản nhất
setTimeout(function() {
    const testMsg = document.getElementById('testMessage');
    if (testMsg) {
        testMsg.innerHTML = 'JavaScript đã chạy! Đang test API...';
        testMsg.className = 'text-success small mt-2';
    }
    
    // Test API
    fetch('/Admin/Dashboard/RecentActivities?take=2')
        .then(response => response.json())
        .then(data => {
            console.log('API Data:', data);
            if (testMsg) {
                testMsg.innerHTML = 'API hoạt động! Có ' + (data.activities ? data.activities.length : 0) + ' hoạt động';
                testMsg.className = 'text-success small mt-2';
            }
        })
        .catch(error => {
            console.error('API Error:', error);
            if (testMsg) {
                testMsg.innerHTML = 'Lỗi API: ' + error.message;
                testMsg.className = 'text-danger small mt-2';
            }
        });
}, 1000);
</script>

<style>
/* Màu sắc phù hợp với cơ quan nhà nước */
.bg-primary { 
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%) !important; 
    box-shadow: 0 4px 15px rgba(30, 58, 138, 0.2) !important;
}

.bg-success { 
    background: linear-gradient(135deg, #059669 0%, #10b981 100%) !important; 
    box-shadow: 0 4px 15px rgba(5, 150, 105, 0.2) !important;
}

.bg-warning { 
    background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%) !important; 
    box-shadow: 0 4px 15px rgba(217, 119, 6, 0.2) !important;
}

.bg-info { 
    background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%) !important; 
    box-shadow: 0 4px 15px rgba(3, 105, 161, 0.2) !important;
}

/* Activity Items */
.activity-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    transition: background-color 0.2s ease;
}

.activity-item:hover {
    background-color: rgba(0,0,0,0.02);
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
    flex-shrink: 0;
}

.activity-content {
    flex: 1;
    min-width: 0;
}

.activity-text {
    margin: 0 0 0.25rem 0;
    color: #1a202c;
    font-weight: 500;
    line-height: 1.4;
}

.activity-time {
    font-size: 0.8rem;
    color: #6c757d;
}
</style>


