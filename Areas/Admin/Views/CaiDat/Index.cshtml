@using WEB_CV.Models
@using WEB_CV.Services.Backup
@{
    ViewData["Title"] = "Cài đặt hệ thống";
    var caiDatChung = ViewBag.CaiDatChung as CaiDatChungVM;
    var caiDatBaoMat = ViewBag.CaiDatBaoMat as CaiDatBaoMatVM;
    var caiDatEmail = ViewBag.CaiDatEmail as CaiDatEmailVM;
    var caiDatGiaoDien = ViewBag.CaiDatGiaoDien as CaiDatGiaoDienVM;
    var caiDatBackup = ViewBag.CaiDatBackup as CaiDatBackupVM;
    var backupSettings = ViewBag.BackupSettings as BackupSettings;
    var backupHistory = ViewBag.BackupHistory as List<BackupRecord>;
    
    string human(long bytes) {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes; int order = 0;
        while (len >= 1024 && order < sizes.Length - 1) { order++; len /= 1024; }
        return string.Format("{0:0.##} {1}", len, sizes[order]);
    }
}

<div class="settings-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-title-section">
                <h1 class="page-title">
                    <i class="fas fa-cog me-3"></i>Cài đặt hệ thống
                </h1>
                <p class="page-subtitle">Quản lý các thiết lập và cấu hình hệ thống</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-outline-secondary me-2" onclick="resetSettings()">
                    <i class="fas fa-undo me-2"></i>Khôi phục mặc định
                </button>
                <button class="btn btn-success" onclick="saveAllSettings()">
                    <i class="fas fa-save me-2"></i>Lưu tất cả
                </button>
            </div>
        </div>
        <div class="page-breadcrumb">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">Admin</a></li>
                    <li class="breadcrumb-item active">Cài đặt</li>
                </ol>
            </nav>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row g-4">
        <!-- Settings Sidebar -->
        <div class="col-lg-3">
            <div class="settings-sidebar">
                <div class="settings-nav">
                    <div class="nav nav-pills flex-column" role="tablist">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#general-settings" type="button" role="tab">
                            <i class="fas fa-sliders-h me-3"></i>
                            <span>Cài đặt chung</span>
                        </button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#security-settings" type="button" role="tab">
                            <i class="fas fa-shield-alt me-3"></i>
                            <span>Bảo mật</span>
                        </button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#email-settings" type="button" role="tab">
                            <i class="fas fa-envelope me-3"></i>
                            <span>Cài đặt Email</span>
                        </button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#appearance-settings" type="button" role="tab">
                            <i class="fas fa-palette me-3"></i>
                            <span>Giao diện</span>
                        </button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#backup-settings" type="button" role="tab">
                            <i class="fas fa-database me-3"></i>
                            <span>Backup & Khôi phục</span>
                        </button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#system-info" type="button" role="tab">
                            <i class="fas fa-info-circle me-3"></i>
                            <span>Thông tin hệ thống</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Content -->
        <div class="col-lg-9">
            <div class="tab-content">
                <!-- General Settings -->
                <div class="tab-pane fade show active" id="general-settings" role="tabpanel">
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h4><i class="fas fa-sliders-h me-2"></i>Cài đặt chung</h4>
                            <p class="mb-0">Quản lý các thiết lập cơ bản của hệ thống</p>
                        </div>
                        <div class="settings-card-body">
                            <form asp-action="UpdateGeneralSettings" method="post">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Tên website</label>
                                            <input type="text" name="TenWebsite" class="form-control" value="@(caiDatChung?.TenWebsite ?? "Cục Chuyển đổi số")" placeholder="Nhập tên website">
                                            <div class="form-text">Tên này sẽ hiển thị trên tiêu đề trang</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Slogan</label>
                                            <input type="text" name="Slogan" class="form-control" value="@(caiDatChung?.Slogan ?? "Đổi mới số - Phát triển bền vững")" placeholder="Nhập slogan">
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-group">
                                            <label class="form-label">Mô tả website</label>
                                            <textarea name="MoTaWebsite" class="form-control" rows="3" placeholder="Nhập mô tả về website">@(caiDatChung?.MoTaWebsite ?? "Website chính thức của Cục Chuyển đổi số - cung cấp thông tin, dịch vụ và giải pháp chuyển đổi số.")</textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="form-label">Email liên hệ</label>
                                            <input type="email" name="EmailLienHe" class="form-control" value="@(caiDatChung?.EmailLienHe ?? "contact@chuyen-doi-so.gov.vn")" placeholder="email@domain.com">
                                        </div>
                                    </div>
                                                                         <div class="col-md-4">
                                         <div class="form-group">
                                             <label class="form-label">Số điện thoại</label>
                                             <input type="tel" name="SoDienThoai" class="form-control" value="@(caiDatChung?.SoDienThoai ?? "(024) 1234-5678")" placeholder="+84 xxx xxx xxx">
                                         </div>
                                     </div>
                                     <div class="col-md-4">
                                         <div class="form-group">
                                             <label class="form-label">Múi giờ</label>
                                             <select name="MuiGio" class="form-select">
                                                 <option value="UTC+7" selected="@(caiDatChung?.MuiGio == "UTC+7")">UTC+7 (Vietnam)</option>
                                                 <option value="UTC+0" selected="@(caiDatChung?.MuiGio == "UTC+0")">UTC+0 (GMT)</option>
                                                 <option value="UTC+8" selected="@(caiDatChung?.MuiGio == "UTC+8")">UTC+8 (China)</option>
                                             </select>
                                         </div>
                                     </div>
                                </div>

                                <div class="settings-section mt-4">
                                    <h6 class="section-title">Thiết lập hiển thị</h6>
                                    <div class="row g-3">
                                                                                 <div class="col-md-4">
                                             <div class="form-group">
                                                 <label class="form-label">Số bài viết/trang</label>
                                                 <select name="SoBaiVietMoiTrang" class="form-select">
                                                     <option value="5" selected="@(caiDatChung?.SoBaiVietMoiTrang == 5)">5</option>
                                                     <option value="10" selected="@(caiDatChung?.SoBaiVietMoiTrang == 10 || caiDatChung?.SoBaiVietMoiTrang == 0)">10</option>
                                                     <option value="20" selected="@(caiDatChung?.SoBaiVietMoiTrang == 20)">20</option>
                                                     <option value="50" selected="@(caiDatChung?.SoBaiVietMoiTrang == 50)">50</option>
                                                 </select>
                                             </div>
                                         </div>
                                         <div class="col-md-4">
                                             <div class="form-group">
                                                 <label class="form-label">Định dạng ngày</label>
                                                 <select name="DinhDangNgay" class="form-select">
                                                     <option value="dd/MM/yyyy" selected="@(caiDatChung?.DinhDangNgay == "dd/MM/yyyy" || string.IsNullOrEmpty(caiDatChung?.DinhDangNgay))">dd/MM/yyyy</option>
                                                     <option value="MM/dd/yyyy" selected="@(caiDatChung?.DinhDangNgay == "MM/dd/yyyy")">MM/dd/yyyy</option>
                                                     <option value="yyyy-MM-dd" selected="@(caiDatChung?.DinhDangNgay == "yyyy-MM-dd")">yyyy-MM-dd</option>
                                                 </select>
                                             </div>
                                         </div>
                                         <div class="col-md-4">
                                             <div class="form-group">
                                                 <label class="form-label">Ngôn ngữ mặc định</label>
                                                 <select name="NgonNguMacDinh" class="form-select">
                                                     <option value="vi" selected="@(caiDatChung?.NgonNguMacDinh == "vi" || string.IsNullOrEmpty(caiDatChung?.NgonNguMacDinh))">Tiếng Việt</option>
                                                     <option value="en" selected="@(caiDatChung?.NgonNguMacDinh == "en")">English</option>
                                                 </select>
                                             </div>
                                         </div>
                                    </div>
                                </div>

                                <div class="settings-actions mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Lưu thay đổi
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2">Hủy</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="tab-pane fade" id="security-settings" role="tabpanel">
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h4><i class="fas fa-shield-alt me-2"></i>Cài đặt bảo mật</h4>
                            <p class="mb-0">Quản lý các thiết lập bảo mật và quyền truy cập</p>
                        </div>
                        <div class="settings-card-body">
                            <form asp-action="UpdateSecuritySettings" method="post">
                                <div class="settings-section">
                                    <h6 class="section-title">Chính sách mật khẩu</h6>
                                    <div class="row g-3">
                                                                                 <div class="col-md-6">
                                             <div class="form-group">
                                                 <label class="form-label">Độ dài tối thiểu</label>
                                                 <select name="DoDaiMatKhauToiThieu" class="form-select">
                                                     <option value="6" selected="@(caiDatBaoMat?.DoDaiMatKhauToiThieu == 6)">6</option>
                                                     <option value="8" selected="@(caiDatBaoMat?.DoDaiMatKhauToiThieu == 8 || caiDatBaoMat?.DoDaiMatKhauToiThieu == 0)">8</option>
                                                     <option value="10" selected="@(caiDatBaoMat?.DoDaiMatKhauToiThieu == 10)">10</option>
                                                     <option value="12" selected="@(caiDatBaoMat?.DoDaiMatKhauToiThieu == 12)">12</option>
                                                 </select>
                                             </div>
                                         </div>
                                         <div class="col-md-6">
                                             <div class="form-group">
                                                 <label class="form-label">Thời gian hết hạn (ngày)</label>
                                                 <input type="number" name="ThoiGianHetHanMatKhau" class="form-control" value="@(caiDatBaoMat?.ThoiGianHetHanMatKhau ?? 90)" min="30" max="365">
                                             </div>
                                         </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-12">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="YeuCauChuHoa" id="requireUppercase" @(caiDatBaoMat?.YeuCauChuHoa == true ? "checked" : "")>
                                                <label class="form-check-label" for="requireUppercase">Yêu cầu chữ hoa</label>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="YeuCauSo" id="requireNumbers" @(caiDatBaoMat?.YeuCauSo == true ? "checked" : "")>
                                                <label class="form-check-label" for="requireNumbers">Yêu cầu số</label>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="YeuCauKyTuDacBiet" id="requireSpecialChars" @(caiDatBaoMat?.YeuCauKyTuDacBiet == true ? "checked" : "")>
                                                <label class="form-check-label" for="requireSpecialChars">Yêu cầu ký tự đặc biệt</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="settings-section mt-4">
                                    <h6 class="section-title">Bảo mật đăng nhập</h6>
                                    <div class="row g-3">
                                                                                 <div class="col-md-6">
                                             <div class="form-group">
                                                 <label class="form-label">Số lần đăng nhập sai tối đa</label>
                                                 <input type="number" name="SoLanDangNhapSaiToiDa" class="form-control" value="@(caiDatBaoMat?.SoLanDangNhapSaiToiDa ?? 5)" min="3" max="10">
                                             </div>
                                         </div>
                                         <div class="col-md-6">
                                             <div class="form-group">
                                                 <label class="form-label">Thời gian khóa tài khoản (phút)</label>
                                                 <input type="number" name="ThoiGianKhoaTaiKhoan" class="form-control" value="@(caiDatBaoMat?.ThoiGianKhoaTaiKhoan ?? 30)" min="5" max="1440">
                                             </div>
                                         </div>
                                    </div>
                                    <div class="form-check form-switch mt-3">
                                        <input class="form-check-input" type="checkbox" name="KichHoatXacThuc2YeuTo" id="enableTwoFactor" @(caiDatBaoMat?.KichHoatXacThuc2YeuTo == true ? "checked" : "")>
                                        <label class="form-check-label" for="enableTwoFactor">
                                            Kích hoạt xác thực 2 yếu tố (2FA)
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="GuiThongBaoDangNhapMoi" id="enableLoginNotification" @(caiDatBaoMat?.GuiThongBaoDangNhapMoi == true ? "checked" : "")>
                                        <label class="form-check-label" for="enableLoginNotification">
                                            Gửi thông báo khi đăng nhập từ thiết bị mới
                                        </label>
                                    </div>
                                </div>

                                <div class="settings-actions mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Lưu thay đổi
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2">Hủy</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Email Settings -->
                <div class="tab-pane fade" id="email-settings" role="tabpanel">
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h4><i class="fas fa-envelope me-2"></i>Cài đặt Email</h4>
                            <p class="mb-0">Cấu hình máy chủ email và template thông báo</p>
                        </div>
                        <div class="settings-card-body">
                            <form asp-action="UpdateEmailSettings" method="post">
                                <div class="settings-section">
                                    <h6 class="section-title">Cấu hình SMTP</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="form-label">Máy chủ SMTP</label>
                                                <input type="text" name="MayKhuSMTP" class="form-control" value="@(caiDatEmail?.MayKhuSMTP ?? "smtp.gmail.com")" placeholder="smtp.example.com">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">Cổng</label>
                                                <input type="number" name="CongSMTP" class="form-control" value="@(caiDatEmail?.CongSMTP ?? 587)" placeholder="587">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">Bảo mật</label>
                                                <select name="BaoMatSMTP" class="form-select">
                                                    <option value="None" selected="@(caiDatEmail?.BaoMatSMTP == "None")">None</option>
                                                    <option value="TLS" selected="@(caiDatEmail?.BaoMatSMTP == "TLS" || string.IsNullOrEmpty(caiDatEmail?.BaoMatSMTP))">TLS</option>
                                                    <option value="SSL" selected="@(caiDatEmail?.BaoMatSMTP == "SSL")">SSL</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="form-label">Tên đăng nhập</label>
                                                <input type="email" name="TenDangNhap" class="form-control" value="@(caiDatEmail?.TenDangNhap ?? "system@chuyen-doi-so.gov.vn")" placeholder="user@example.com">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="form-label">Mật khẩu</label>
                                                <div class="input-group">
                                                    <input type="password" name="MatKhau" class="form-control" value="@(caiDatEmail?.MatKhau ?? "")" id="emailPassword" placeholder="Nhập mật khẩu">
                                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('emailPassword')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="settings-section mt-4">
                                    <h6 class="section-title">Thông tin gửi</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="form-label">Tên người gửi</label>
                                                <input type="text" name="TenNguoiGui" class="form-control" value="@(caiDatEmail?.TenNguoiGui ?? "Cục Chuyển đổi số")" placeholder="Tên hiển thị">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="form-label">Email người gửi</label>
                                                <input type="email" name="EmailNguoiGui" class="form-control" value="@(caiDatEmail?.EmailNguoiGui ?? "noreply@chuyen-doi-so.gov.vn")" placeholder="noreply@example.com">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="settings-section mt-4">
                                    <h6 class="section-title">Thông báo email</h6>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="GuiEmailNguoiDungMoi" id="emailNewUser" @(caiDatEmail?.GuiEmailNguoiDungMoi == true ? "checked" : "")>
                                        <label class="form-check-label" for="emailNewUser">
                                            Gửi email chào mừng người dùng mới
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="ThongBaoBaiVietMoi" id="emailNewPost" @(caiDatEmail?.ThongBaoBaiVietMoi == true ? "checked" : "")>
                                        <label class="form-check-label" for="emailNewPost">
                                            Thông báo bài viết mới cho subscriber
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="ThongBaoPhanHoi" id="emailCommentReply" @(caiDatEmail?.ThongBaoPhanHoi == true ? "checked" : "")>
                                        <label class="form-check-label" for="emailCommentReply">
                                            Thông báo phản hồi bình luận
                                        </label>
                                    </div>
                                </div>

                                <div class="settings-actions mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Lưu cấu hình
                                    </button>
                                    <button type="button" class="btn btn-outline-info ms-2" onclick="testEmailConnection()">
                                        <i class="fas fa-paper-plane me-2"></i>Test kết nối
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Appearance Settings -->
                <div class="tab-pane fade" id="appearance-settings" role="tabpanel">
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h4><i class="fas fa-palette me-2"></i>Cài đặt giao diện</h4>
                            <p class="mb-0">Tùy chỉnh màu sắc và giao diện website</p>
                        </div>
                        <div class="settings-card-body">
                                                         <form asp-action="UpdateAppearanceSettings" method="post">
                                 <div class="settings-section">
                                     <h6 class="section-title">Chủ đề màu sắc</h6>
                                     <div class="row g-3">
                                         <div class="col-12">
                                             <div class="theme-options">
                                                 <div class="theme-option @(caiDatGiaoDien?.ChuDeManSac == "blue" || string.IsNullOrEmpty(caiDatGiaoDien?.ChuDeManSac) ? "active" : "")" data-theme="blue">
                                                     <input type="radio" name="ChuDeManSac" value="blue" @(caiDatGiaoDien?.ChuDeManSac == "blue" || string.IsNullOrEmpty(caiDatGiaoDien?.ChuDeManSac) ? "checked" : "") style="display: none;">
                                                     <div class="theme-colors">
                                                         <span style="background: #3b82f6;"></span>
                                                         <span style="background: #1d4ed8;"></span>
                                                         <span style="background: #1e40af;"></span>
                                                     </div>
                                                     <span class="theme-name">Xanh dương (Mặc định)</span>
                                                 </div>
                                                 <div class="theme-option @(caiDatGiaoDien?.ChuDeManSac == "green" ? "active" : "")" data-theme="green">
                                                     <input type="radio" name="ChuDeManSac" value="green" @(caiDatGiaoDien?.ChuDeManSac == "green" ? "checked" : "") style="display: none;">
                                                     <div class="theme-colors">
                                                         <span style="background: #10b981;"></span>
                                                         <span style="background: #059669;"></span>
                                                         <span style="background: #047857;"></span>
                                                     </div>
                                                     <span class="theme-name">Xanh lá</span>
                                                 </div>
                                                 <div class="theme-option @(caiDatGiaoDien?.ChuDeManSac == "purple" ? "active" : "")" data-theme="purple">
                                                     <input type="radio" name="ChuDeManSac" value="purple" @(caiDatGiaoDien?.ChuDeManSac == "purple" ? "checked" : "") style="display: none;">
                                                     <div class="theme-colors">
                                                         <span style="background: #8b5cf6;"></span>
                                                         <span style="background: #7c3aed;"></span>
                                                         <span style="background: #6d28d9;"></span>
                                                     </div>
                                                     <span class="theme-name">Tím</span>
                                                 </div>
                                                 <div class="theme-option @(caiDatGiaoDien?.ChuDeManSac == "red" ? "active" : "")" data-theme="red">
                                                     <input type="radio" name="ChuDeManSac" value="red" @(caiDatGiaoDien?.ChuDeManSac == "red" ? "checked" : "") style="display: none;">
                                                     <div class="theme-colors">
                                                         <span style="background: #ef4444;"></span>
                                                         <span style="background: #dc2626;"></span>
                                                         <span style="background: #b91c1c;"></span>
                                                     </div>
                                                     <span class="theme-name">Đỏ</span>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                 </div>

                            <div class="settings-section mt-4">
                                <h6 class="section-title">Logo & Favicon</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Logo header</label>
                                            <div class="logo-upload">
                                                <img src="~/img/logo.png" alt="Current Logo" class="current-logo">
                                                <div class="upload-overlay">
                                                    <button class="btn btn-sm btn-light" type="button">
                                                        <i class="fas fa-camera me-2"></i>Thay đổi
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Favicon</label>
                                            <div class="favicon-upload">
                                                <img src="~/favicon.ico" alt="Current Favicon" class="current-favicon">
                                                <div class="upload-overlay">
                                                    <button class="btn btn-sm btn-light" type="button">
                                                        <i class="fas fa-upload me-2"></i>Upload
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                                             <div class="settings-section mt-4">
                                     <h6 class="section-title">Tùy chỉnh CSS</h6>
                                     <div class="form-group">
                                         <label class="form-label">Custom CSS</label>
                                         <textarea name="CustomCSS" class="form-control code-editor" rows="8" placeholder="/* Nhập CSS tùy chỉnh ở đây */">@(caiDatGiaoDien?.CustomCSS ?? "")</textarea>
                                         <div class="form-text">CSS sẽ được áp dụng cho toàn bộ website</div>
                                     </div>
                                 </div>

                                 <div class="settings-actions mt-4">
                                     <button type="submit" class="btn btn-primary">
                                         <i class="fas fa-save me-2"></i>Lưu giao diện
                                     </button>
                                     <button type="button" class="btn btn-outline-info ms-2" onclick="previewChanges()">
                                         <i class="fas fa-eye me-2"></i>Xem trước
                                     </button>
                                 </div>
                             </form>
                        </div>
                    </div>
                </div>

                <!-- Backup Settings -->
                <div class="tab-pane fade" id="backup-settings" role="tabpanel">
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h4><i class="fas fa-database me-2"></i>Backup & Khôi phục</h4>
                            <p class="mb-0">Quản lý sao lưu và khôi phục dữ liệu hệ thống</p>
                        </div>
                        <div class="settings-card-body">
                            <div class="settings-section">
                                <h6 class="section-title">Tự động backup</h6>
                                <form asp-action="SaveBackupSettings" method="post">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">Tần suất</label>
                                            <select class="form-select" name="Frequency">
                                                @if (backupSettings?.Frequency == "Daily")
                                                {
                                                    <option value="Daily" selected>Daily</option>
                                                    <option value="Weekly">Weekly</option>
                                                    <option value="Monthly">Monthly</option>
                                                }
                                                else if (backupSettings?.Frequency == "Monthly")
                                                {
                                                    <option value="Daily">Daily</option>
                                                    <option value="Weekly">Weekly</option>
                                                    <option value="Monthly" selected>Monthly</option>
                                                }
                                                else
                                                {
                                                    <option value="Daily">Daily</option>
                                                    <option value="Weekly" selected>Weekly</option>
                                                    <option value="Monthly">Monthly</option>
                                                }
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Giờ thực hiện</label>
                                            <input class="form-control" name="TimeOfDay" value="@(backupSettings?.TimeOfDay ?? "02:00")" placeholder="02:00" />
                                            <small class="text-muted">Định dạng 24h HH:mm</small>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Số lượng giữ lại</label>
                                            <input class="form-control" name="RetentionCount" value="@(backupSettings?.RetentionCount ?? 10)" type="number" min="1" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Thư mục lưu trữ</label>
                                            <input class="form-control" name="StoragePath" value="@(backupSettings?.StoragePath ?? "backups")" />
                                        </div>
                                    </div>

                                    <div class="row g-3 mt-2">
                                        <div class="col-md-12">
                                            <label class="form-label">Thư mục đưa vào backup (mỗi mục một dòng)</label>
                                            <textarea class="form-control" rows="2" name="IncludeFolders">@string.Join("\n", backupSettings?.IncludeFolders ?? new List<string> { "wwwroot" })</textarea>
                                            <small class="text-muted">Mặc định: wwwroot. Có thể thêm "App_Data", "Uploads"…</small>
                                        </div>
                                    </div>

                                    <div class="form-check form-switch mt-3">
                                        <input class="form-check-input" type="checkbox" id="enabledSwitch" name="Enabled" value="true" @(backupSettings?.Enabled == true ? "checked" : "") />
                                        <label class="form-check-label" for="enabledSwitch">Bật tự động backup</label>
                                    </div>

                                    <div class="settings-actions mt-4">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>Lưu cài đặt backup
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <div class="settings-section mt-4">
                                <h6 class="section-title">Backup thủ công</h6>
                                <div class="backup-actions">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <form asp-action="CreateBackup" asp-antiforgery="true" method="post" class="d-inline w-100">
                                                <input type="hidden" name="type" value="full" />
                                                <button class="btn btn-primary w-100" type="submit">
                                                    <i class="fas fa-download me-2"></i>
                                                    <div>Backup toàn bộ</div>
                                                    <small class="d-block mt-1 opacity-75">Database + Files</small>
                                                </button>
                                            </form>
                                        </div>
                                        <div class="col-md-4">
                                            <form asp-action="CreateBackup" asp-antiforgery="true" method="post" class="d-inline w-100">
                                                <input type="hidden" name="type" value="database" />
                                                <button class="btn btn-outline-primary w-100" type="submit">
                                                    <i class="fas fa-database me-2"></i>
                                                    <div>Backup Database</div>
                                                    <small class="d-block mt-1 opacity-75">Chỉ dữ liệu</small>
                                                </button>
                                            </form>
                                        </div>
                                        <div class="col-md-4">
                                            <form asp-action="CreateBackup" asp-antiforgery="true" method="post" class="d-inline w-100">
                                                <input type="hidden" name="type" value="files" />
                                                <button class="btn btn-outline-primary w-100" type="submit">
                                                    <i class="fas fa-folder me-2"></i>
                                                    <div>Backup Files</div>
                                                    <small class="d-block mt-1 opacity-75">Chỉ tệp tin</small>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section mt-4">
                                <h6 class="section-title">Lịch sử backup</h6>
                                <div class="backup-history">
                                    @if (backupHistory != null && backupHistory.Any())
                                    {
                                        @foreach (var item in backupHistory)
                                        {
                                            <div class="backup-item">
                                                <div class="backup-info">
                                                    <div class="backup-name">@item.FileName</div>
                                                    <div class="backup-details">
                                                        <span class="backup-size">@human(item.SizeBytes)</span>
                                                        <span class="backup-date">@item.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                                        <span class="backup-type badge @(item.Type == "full" ? "bg-primary" : item.Type == "db" ? "bg-info" : "bg-secondary")">
                                                            @(item.Type == "full" ? "Full" : item.Type == "db" ? "DB" : "Files")
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="backup-actions">
                                                    <a class="btn btn-sm btn-outline-success" asp-action="DownloadBackup" asp-route-fileName="@item.FileName" title="Tải xuống">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                    <form class="d-inline" asp-action="RestoreBackup" method="post">
                                                        <input type="hidden" name="fileName" value="@item.FileName" />
                                                        <button class="btn btn-sm btn-outline-warning" onclick="return confirm('Khôi phục file này? Ứng dụng có thể cần khởi động lại.');" title="Khôi phục">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                    </form>
                                                    <form class="d-inline" asp-action="DeleteBackup" method="post">
                                                        <input type="hidden" name="fileName" value="@item.FileName" />
                                                        <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Xoá file này?');" title="Xoá">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-database fa-3x mb-3"></i>
                                            <p>Chưa có backup nào được tạo</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Info -->
                <div class="tab-pane fade" id="system-info" role="tabpanel">
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h4><i class="fas fa-info-circle me-2"></i>Thông tin hệ thống</h4>
                            <p class="mb-0">Chi tiết về phiên bản và trạng thái hệ thống</p>
                        </div>
                        <div class="settings-card-body">
                            <div class="row g-4">
                                <div class="col-lg-6">
                                    <div class="system-info-section">
                                        <h6 class="section-title">Thông tin phiên bản</h6>
                                        <div class="info-list">
                                            <div class="info-item">
                                                <span class="info-label">Phiên bản hệ thống:</span>
                                                <span class="info-value" data-info="version">2.1.0</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">.NET Version:</span>
                                                <span class="info-value" data-info="dotnet">9.0</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Entity Framework:</span>
                                                <span class="info-value">9.0.0</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Bootstrap:</span>
                                                <span class="info-value">5.3.0</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Ngày cập nhật cuối:</span>
                                                <span class="info-value">09/03/2025</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="system-info-section">
                                        <h6 class="section-title">Trạng thái hệ thống</h6>
                                        <div class="info-list">
                                            <div class="info-item">
                                                <span class="info-label">Thời gian chạy:</span>
                                                <span class="info-value" data-info="uptime">15 ngày 8 giờ</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Bộ nhớ sử dụng:</span>
                                                <span class="info-value" data-info="memory">245 MB</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Dung lượng Database:</span>
                                                <span class="info-value" data-info="dbsize">127.8 MB</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Dung lượng Files:</span>
                                                <span class="info-value" data-info="filessize">2.3 GB</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Kết nối Database:</span>
                                                <span class="info-value text-success" data-info="dbstatus"><i class="fas fa-check-circle me-1"></i>Hoạt động tốt</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="system-info-section mt-4">
                                <h6 class="section-title">Kiểm tra hệ thống</h6>
                                <div class="health-check">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="health-item">
                                                <div class="health-icon success">
                                                    <i class="fas fa-database"></i>
                                                </div>
                                                <div class="health-content">
                                                    <div class="health-title">Kết nối Database</div>
                                                    <div class="health-status text-success">Hoạt động bình thường</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="health-item">
                                                <div class="health-icon success">
                                                    <i class="fas fa-envelope"></i>
                                                </div>
                                                <div class="health-content">
                                                    <div class="health-title">Dịch vụ Email</div>
                                                    <div class="health-status text-success">Kết nối thành công</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="health-item">
                                                <div class="health-icon warning">
                                                    <i class="fas fa-hdd"></i>
                                                </div>
                                                <div class="health-content">
                                                    <div class="health-title">Dung lượng ổ cứng</div>
                                                    <div class="health-status text-warning">75% đã sử dụng</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="health-item">
                                                <div class="health-icon success">
                                                    <i class="fas fa-shield-alt"></i>
                                                </div>
                                                <div class="health-content">
                                                    <div class="health-title">Bảo mật</div>
                                                    <div class="health-status text-success">An toàn</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="system-actions mt-4">
                                <button class="btn btn-info me-2" onclick="refreshSystemInfo()">
                                    <i class="fas fa-sync-alt me-2"></i>Làm mới thông tin
                                </button>
                                <button class="btn btn-success me-2" onclick="runSystemCheck()">
                                    <i class="fas fa-stethoscope me-2"></i>Kiểm tra hệ thống
                                </button>
                                <button class="btn btn-warning" onclick="clearCache()">
                                    <i class="fas fa-broom me-2"></i>Xóa cache
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Settings specific styles */
.settings-container {
    padding: 0;
}

.settings-sidebar {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    height: fit-content;
    position: sticky;
    top: 20px;
}

.settings-nav .nav-link {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    border: none;
    border-radius: 8px;
    background: transparent;
    color: #6c757d;
    transition: all 0.2s ease;
    text-align: left;
    width: 100%;
    font-weight: 500;
}

.settings-nav .nav-link:hover {
    background: rgba(13, 110, 253, 0.1);
    color: #0d6efd;
}

.settings-nav .nav-link.active {
    background: #0d6efd;
    color: white;
}

.settings-nav .nav-link i {
    width: 20px;
    text-align: center;
}

.settings-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.settings-card-header {
    padding: 2rem 2rem 1rem 2rem;
    border-bottom: 1px solid #e9ecef;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px 12px 0 0;
}

.settings-card-header h4 {
    margin-bottom: 0.5rem;
    color: #2d3748;
    font-weight: 600;
}

.settings-card-header p {
    color: #6c757d;
    font-size: 0.9rem;
}

.settings-card-body {
    padding: 2rem;
}

.settings-section {
    margin-bottom: 2rem;
}

.section-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
    font-size: 1rem;
}

.settings-actions {
    padding-top: 1.5rem;
    border-top: 1px solid #e9ecef;
}

/* Theme options */
.theme-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.theme-option {
    padding: 1rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.theme-option:hover {
    border-color: #0d6efd;
}

.theme-option.active {
    border-color: #0d6efd;
    background: rgba(13, 110, 253, 0.05);
}

.theme-colors {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.theme-colors span {
    width: 20px;
    height: 20px;
    border-radius: 50%;
}

.theme-name {
    font-weight: 500;
    color: #2d3748;
}

/* Logo upload */
.logo-upload, .favicon-upload {
    position: relative;
    display: inline-block;
    border-radius: 8px;
    overflow: hidden;
}

.current-logo {
    width: 120px;
    height: 60px;
    object-fit: contain;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 0.5rem;
}

.current-favicon {
    width: 64px;
    height: 64px;
    object-fit: contain;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 0.5rem;
}

.upload-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.logo-upload:hover .upload-overlay,
.favicon-upload:hover .upload-overlay {
    opacity: 1;
}

/* Code editor */
.code-editor {
    font-family: 'Courier New', monospace;
    background: #1e1e1e;
    color: #d4d4d4;
    border: 1px solid #404040;
}

.code-editor:focus {
    background: #1e1e1e;
    color: #d4d4d4;
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Backup history */
.backup-history {
    max-height: 400px;
    overflow-y: auto;
}

.backup-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    background: #f8f9fa;
}

.backup-info {
    flex: 1;
}

.backup-name {
    font-weight: 500;
    color: #2d3748;
    margin-bottom: 0.25rem;
}

.backup-details {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: #6c757d;
}

.backup-actions {
    display: flex;
    gap: 0.5rem;
}

/* System info */
.system-info-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
}

.info-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e9ecef;
}

.info-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.info-label {
    font-weight: 500;
    color: #495057;
}

.info-value {
    color: #2d3748;
    font-weight: 600;
}

/* Health check */
.health-check {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
}

.health-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.health-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.health-icon.success {
    background: rgba(25, 135, 84, 0.1);
    color: #198754;
}

.health-icon.warning {
    background: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.health-icon.danger {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
}

.health-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.25rem;
}

.health-status {
    font-size: 0.875rem;
}

 /* Theme switching */
 :root {
     --primary-color: #3b82f6;
     --primary-dark: #1d4ed8;
     --primary-darker: #1e40af;
 }

 .theme-blue {
     --primary-color: #3b82f6;
     --primary-dark: #1d4ed8;
     --primary-darker: #1e40af;
 }

 .theme-green {
     --primary-color: #10b981;
     --primary-dark: #059669;
     --primary-darker: #047857;
 }

 .theme-purple {
     --primary-color: #8b5cf6;
     --primary-dark: #7c3aed;
     --primary-darker: #6d28d9;
 }

 .theme-red {
     --primary-color: #ef4444;
     --primary-dark: #dc2626;
     --primary-darker: #b91c1c;
 }

 /* Apply theme colors to buttons and links */
 .btn-primary {
     background-color: var(--primary-color);
     border-color: var(--primary-color);
 }

 .btn-primary:hover {
     background-color: var(--primary-dark);
     border-color: var(--primary-dark);
 }

 .settings-nav .nav-link.active {
     background: var(--primary-color);
 }

 .settings-nav .nav-link:hover {
     background: rgba(var(--primary-color), 0.1);
     color: var(--primary-color);
 }

 .theme-option.active {
     border-color: var(--primary-color);
     background: rgba(var(--primary-color), 0.05);
 }

 /* Responsive */
 @@media (max-width: 991px) {
    .settings-sidebar {
        position: static;
        margin-bottom: 1.5rem;
    }
    
    .settings-nav .nav-link {
        font-size: 0.9rem;
    }
    
    .theme-options {
        grid-template-columns: 1fr;
    }
}

@@media (max-width: 768px) {
    .settings-card-body {
        padding: 1rem;
    }
    
    .settings-card-header {
        padding: 1.5rem 1rem 1rem 1rem;
    }
    
    .backup-item {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .health-item {
        flex-direction: column;
        text-align: center;
    }
}
</style>

<script>
// Tab functionality
document.addEventListener('DOMContentLoaded', function() {
    // Handle tab switching
    const navButtons = document.querySelectorAll('.settings-nav .nav-link');
    navButtons.forEach(button => {
        button.addEventListener('click', function() {
            navButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
         // Theme selection
     const themeOptions = document.querySelectorAll('.theme-option');
     themeOptions.forEach(option => {
         option.addEventListener('click', function() {
             // Remove active class from all options
             themeOptions.forEach(o => o.classList.remove('active'));
             
             // Add active class to clicked option
             this.classList.add('active');
             
             // Update radio button
             const radio = this.querySelector('input[type="radio"]');
             if (radio) {
                 radio.checked = true;
             }
             
             // Apply theme preview
             const theme = this.getAttribute('data-theme');
             applyThemePreview(theme);
         });
     });
});

// Utility functions
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.parentElement.querySelector('button i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function saveAllSettings() {
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang lưu...';
    btn.disabled = true;
    
    // Simulate API call
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        // Show success message
        const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                Tất cả cài đặt đã được lưu thành công!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const container = document.querySelector('.settings-container');
        container.insertAdjacentHTML('afterbegin', alertHtml);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }, 2000);
}

function resetSettings() {
    if (confirm('Bạn có chắc chắn muốn khôi phục tất cả cài đặt về mặc định?')) {
        // Show loading
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang khôi phục...';
        btn.disabled = true;
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Cài đặt đã được khôi phục về mặc định!');
            location.reload();
        }, 2000);
    }
}

async function testEmailConnection() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang test...';
    btn.disabled = true;
    
    try {
        // Lấy dữ liệu từ form
        const formData = new FormData();
        formData.append('MayKhuSMTP', document.querySelector('input[name="MayKhuSMTP"]')?.value || '');
        formData.append('CongSMTP', document.querySelector('input[name="CongSMTP"]')?.value || '');
        formData.append('BaoMatSMTP', document.querySelector('select[name="BaoMatSMTP"]')?.value || '');
        formData.append('TenDangNhap', document.querySelector('input[name="TenDangNhap"]')?.value || '');
        formData.append('MatKhau', document.querySelector('input[name="MatKhau"]')?.value || '');
        formData.append('TenNguoiGui', document.querySelector('input[name="TenNguoiGui"]')?.value || '');
        formData.append('EmailNguoiGui', document.querySelector('input[name="EmailNguoiGui"]')?.value || '');
        
        const response = await fetch('/Admin/CaiDat/TestEmailConnection', {
            method: 'POST',
            body: formData,
            headers: {
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message, 'success');
        } else {
            showNotification(result.message, 'error');
        }
    } catch (error) {
        showNotification('Có lỗi xảy ra khi test kết nối email', 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function previewChanges() {
    const selectedTheme = document.querySelector('input[name="ChuDeManSac"]:checked')?.value || 'blue';
    const customCSS = document.querySelector('textarea[name="CustomCSS"]')?.value || '';
    
    // Apply theme preview
    applyThemePreview(selectedTheme);
    
    // Apply custom CSS preview
    if (customCSS.trim()) {
        applyCustomCSSPreview(customCSS);
    }
    
    showNotification('Đã áp dụng xem trước! Nhấn F5 để tải lại trang nếu muốn xem thay đổi.', 'info');
}

function applyThemePreview(theme) {
    // Remove existing theme classes
    document.body.classList.remove('theme-blue', 'theme-green', 'theme-purple', 'theme-red');
    
    // Add new theme class
    document.body.classList.add(`theme-${theme}`);
    
    // Update CSS variables for preview
    const root = document.documentElement;
    const themes = {
        blue: {
            '--primary-color': '#3b82f6',
            '--primary-dark': '#1d4ed8',
            '--primary-darker': '#1e40af'
        },
        green: {
            '--primary-color': '#10b981',
            '--primary-dark': '#059669',
            '--primary-darker': '#047857'
        },
        purple: {
            '--primary-color': '#8b5cf6',
            '--primary-dark': '#7c3aed',
            '--primary-darker': '#6d28d9'
        },
        red: {
            '--primary-color': '#ef4444',
            '--primary-dark': '#dc2626',
            '--primary-darker': '#b91c1c'
        }
    };
    
    const themeColors = themes[theme] || themes.blue;
    Object.entries(themeColors).forEach(([property, value]) => {
        root.style.setProperty(property, value);
    });
}

function applyCustomCSSPreview(css) {
    // Remove existing preview style
    let previewStyle = document.getElementById('custom-css-preview');
    if (previewStyle) {
        previewStyle.remove();
    }
    
    // Add new preview style
    previewStyle = document.createElement('style');
    previewStyle.id = 'custom-css-preview';
    previewStyle.textContent = css;
    document.head.appendChild(previewStyle);
}

// Notification function
function showNotification(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
    const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas ${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.settings-container');
    const existingAlert = container.querySelector('.alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

// Backup functions - now handled by form submission

// System functions
async function refreshSystemInfo() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang làm mới...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/Admin/CaiDat/GetSystemInfo');
        const result = await response.json();
        
        if (result.success) {
            // Update system info display
            updateSystemInfoDisplay(result.data);
            showNotification('Thông tin hệ thống đã được cập nhật!', 'success');
        } else {
            showNotification('Không thể cập nhật thông tin hệ thống', 'error');
        }
    } catch (error) {
        showNotification('Có lỗi xảy ra khi cập nhật thông tin', 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function runSystemCheck() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang kiểm tra...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        alert('Kiểm tra hệ thống hoàn tất! Tất cả đều hoạt động bình thường.');
    }, 4000);
}

async function clearCache() {
    if (confirm('Xóa toàn bộ cache hệ thống?')) {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xóa...';
        btn.disabled = true;
        
        try {
            const response = await fetch('/Admin/CaiDat/ClearCache', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification(result.message, 'success');
            } else {
                showNotification(result.message, 'error');
            }
        } catch (error) {
            showNotification('Có lỗi xảy ra khi xóa cache', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
}

// Helper function to update system info display
function updateSystemInfoDisplay(data) {
    // Update version info
    const versionElements = document.querySelectorAll('[data-info="version"]');
    versionElements.forEach(el => el.textContent = data.version);
    
    const dotnetElements = document.querySelectorAll('[data-info="dotnet"]');
    dotnetElements.forEach(el => el.textContent = data.dotnetVersion);
    
    const uptimeElements = document.querySelectorAll('[data-info="uptime"]');
    uptimeElements.forEach(el => el.textContent = data.uptime);
    
    const memoryElements = document.querySelectorAll('[data-info="memory"]');
    memoryElements.forEach(el => el.textContent = data.memoryUsage);
    
    const dbSizeElements = document.querySelectorAll('[data-info="dbsize"]');
    dbSizeElements.forEach(el => el.textContent = data.databaseSize);
    
    const filesSizeElements = document.querySelectorAll('[data-info="filessize"]');
    filesSizeElements.forEach(el => el.textContent = data.filesSize);
    
    const dbStatusElements = document.querySelectorAll('[data-info="dbstatus"]');
    dbStatusElements.forEach(el => el.textContent = data.databaseStatus);
}
</script>

</script>
